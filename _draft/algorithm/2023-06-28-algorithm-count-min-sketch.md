---
layout: default
title: 'count min sketch'
parent: algorithm
nav_order: 3
date: '2023-06-28'
author: 'Young Hwang'
description: 'count min sketch'
tags: ['algorithm']
---

#

컴퓨팅에서 Kahneman 스케치는 스트리밍 데이터에서 이벤트의 빈도를 계산하는 확률적 데이터 구조입니다.
이러한 빈도를 메트릭에 맵핑하는 여러 해시 함수를 제공하므로 직접 비교 대신 해시 테이블을 사용할 수 있습니다.

![count-min-sketch-00.jpg](https://young-hwang.github.io/docs/algorithm/images/count-min-sketch-00.jpg)

이러한 스케치에서는 빈도를 훨씬 더 효율적으로 계산할 수 있습니다.
이 알고리즘은 매우 작은 공간을 사용하거나 빈도를 계산하기 위해 준선형(sublinear)공간을 활용 합니다.
유일한 단점은 매우 드문경우로 해시 충돌로 모든 빈도를 계산한다는 것 입니다.

여기서 이야기하는 준선형(sublinear) 공간은 무엇일까요?
sketch에 대한 이해를 하려면 먼저 준선형의 의미를 알필요가 있습니다.

![count-min-sketch-01.jpg](https://young-hwang.github.io/docs/algorithm/images/count-min-sketch-01.jpg)

위의 이미지를 보면 데이터의 증가함에 따라 공간 즉 메모리의 소비도 같은 방식으로 증가하게 되는 선형 그래프를 볼수 있습니다.
반면 준선형은 선형 처럼 많은 데이터를 소비하지는 않지만 그와 비슷한 결과를 나타낼수 있습니다.

그리고 빈도를 계산한다고 하였는데 이건 또 어떤 의미인지 간단히 예를 들어 셜명하겠습니다.

```javascript
[A, B, B, N, A, R, E, A, R, A, B]
```

만약 위와 같이 데이터 스트림이 있고, 이 데이터 스트림에서 문자의 빈도를 세어야 한다고 해봅시다.
그렇다면 결과는 아래와 같을 것 입니다.
이처럼 CM Sketch 는 각 항목에 대한 빈도를 표현하는 sketch 중 하나 입니다.

```javascript
A - 4, B - 3,  E - 1,  N - 1,  R - 2
```

여기서 나아가 결과를 일정한 시간 간격으로 집계를 한다면 어떻게 해야될까요?
또한 이를 임의의 범위로 조회를 한다고 하면 가능할까요?

물론 위의 결과를 이용하여 n 시간 순서로 집계 및 조회 할 수 있습니다.
하지만 이러한 데이터 스트림이 계속해서 증가하며 무한하다면 어떨까요?

무한한 스트림을 처리하여 하루에 1TB의 데이터가 생성되다고 해봅시다.
한달이면 30TB의 데이터가 생성될 것입니다.

물론 30TB를 충분히 저장할수 있는 공간이 있을 수도 있습니다.
하지만 이러한 공간은 무한하지 않으며 우리는 제한된 공간과 시간, 비용을 고려하여야 합니다.
시스템에서 한달간의 데이터의 빈도를 계산이 필요 하다면 우리는 30TB의 데이터를 이용하여 계산하여야 합니다.
이는 우리가 결과를 도출하기에 많은 시간이 걸릴 수 있습니다.
하지만 시스템은 많은 시간을 할당할 수 없기에 제한되 시간내에 결과를 도출하여야 합니다.

이러한 조회 범위에 따른 공간과 시간제약 문제는 IMQA에서도 격고 있는 사항입니다.

![count-min-sketch-02.png](https://young-hwang.github.io/docs/algorithm/images/count-min-sketch-02.png)

위의 이미지는 통계 > 구간분석 화면에서 '네이티브 응답속도'를 표현한 히트맵 차트 입니다.
시간의 범위에 따른 응답 속도를 구간별로 그룹화하여 빈도를 표현하고 있습니다.
저희는 MySQL에 raw 데이터를 저장하고 있고 시간당 많게는 40만건 정도의 데이터를 조회하여 빈도를 계산하여야 합니다.
이를 실시간으로 조회 하기에는 시간의 제약으로 사실상 사용이 불가능한 수준 이였습니다.

이를 개선하고자 현재는 30분 단위로 조회 범위를 지정하고 배치를 이용하여 데어터를 집계하여 집계 데이터를 생성 후 조회를 하고 있습니다.
집계가 완료된 데이터를 조회하기에 시간적 제약은 벗어 났지만 30분마다 데이터를 집계하기에 선형 공간 사용으로 인한 문제가 현재도 발생하고 있습니다.
따라서 선형 공간을 가질 여유가 우리에겐 없기에 이를 준선형 공간으로 바꿀 필요가 있습니다.

이러한 문제에 대한 솔루션은 준선형(sublinear) 알고리즘을 사용하는 것입니다.
준선형(sublinear) 알고리즘을 사용 시 데이터를 압축하여 작은 공간에 저장하므로 데이터 손실이 있을 수 있습니다.
즉 약간의 부정확성이 있습니다.














# 소개

# 사전 준비

# Count-Min Sketch

Count-Min(CM) Sketch에 대하여 소개하겠다.
Point Query의 응답에 사용되는 두가지 기본 작업의 이름을 따서 명명 되었으며, 이는 먼저 counting하고 다음으로 최소값을 계산하는 것 입니다.
$e$를 사용하여 자연 로그 함수(ln)를 표현합니다.


# CM Sketch를 이용한 쿼리

## Point Query

## Inner Product Query

## Range Query

# CM Sketch의 응용

# Sketch 기법의 비교

# 결론

# 참고

$e$ : Euler's number. 수학의 상수. 대략 2.71828로 표현

natural logarithm: 수학 상수 $e$ 를 밑으로 하는 로그 함수. e.g. $ln 7.5 = 2.0149..$ 왜냐하면 $e^{2.0149}\dots = 7.5$ 이기 때문이다.

$\epsilon$ : 0에 가까운 양을 나타내는 기호

$1/\epsilon$ : $\epsilon$의 역수. $\epsilon$이 작아지면 $1/\epsilon$ 이 아주 큰 수가 된다. ex) $\epsilon$ = 0.1, $1/\epsilon$ = 10

$\omega =\lceil \frac{e}{\epsilon} \rceil$ :  $\epsilon$는 Count-Min 스케치의 오차 범위를 나타내는 파라미터이며, e는 자연 상수 (약 2.71828...)입니다. 즉, ω는 e를 ε로 나눈 값을 올림한 결과를 나타냅니다. 이 값은 Count-Min 스케치의 파라미터 설정과 관련하여 사용될 수 있습니다.

$d = \lceil ln(\frac{1}{\delta})\rceil$ : $\delta$는 Count-Min 스케치의 확률적 보장 수준을 나타내는 파라미터이며, ln은 자연 로그 함수입니다. 즉, d는 ln(1/δ)를 올림한 결과를 나타냅니다. 이 값은 Count-Min 스케치의 파라미터 설정과 관련하여 사용될 수 있습니다.

Chebyshev inequality(체비 쇼프 부등식)
