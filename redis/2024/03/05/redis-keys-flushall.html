<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-translate-customization" content="108d9124921d80c3-80e20d618ff053c8-g4f02ec6f3dba68b7-c">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>KEYS와 FLUSHALL 명령어를 쓰지 말아야되는 이유 | Young’s Logs</title>
<meta name="generator" content="Jekyll v4.3.3">
<meta property="og:title" content="KEYS와 FLUSHALL 명령어를 쓰지 말아야되는 이유">
<meta name="author" content="Young Hwang">
<meta property="og:locale" content="en_US">
<meta name="description" content="Redis를 사용하다 보면 의도하지 않은 장애가 발생하거나 성능이 저하되는 경우가 있습니다. 이들은 모두 Redis가 싱글 스레드라는 것을 잊어 버리거나 모르고 있기 때문에 발생하는 문제입니다.">
<meta property="og:description" content="Redis를 사용하다 보면 의도하지 않은 장애가 발생하거나 성능이 저하되는 경우가 있습니다. 이들은 모두 Redis가 싱글 스레드라는 것을 잊어 버리거나 모르고 있기 때문에 발생하는 문제입니다.">
<link rel="canonical" href="/redis/2024/03/05/redis-keys-flushall.html">
<meta property="og:url" content="/redis/2024/03/05/redis-keys-flushall.html">
<meta property="og:site_name" content="Young’s Logs">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-03-05T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="KEYS와 FLUSHALL 명령어를 쓰지 말아야되는 이유">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Young Hwang"},"dateModified":"2024-03-05T00:00:00+00:00","datePublished":"2024-03-05T00:00:00+00:00","description":"Redis를 사용하다 보면 의도하지 않은 장애가 발생하거나 성능이 저하되는 경우가 있습니다. 이들은 모두 Redis가 싱글 스레드라는 것을 잊어 버리거나 모르고 있기 때문에 발생하는 문제입니다.","headline":"KEYS와 FLUSHALL 명령어를 쓰지 말아야되는 이유","mainEntityOfPage":{"@type":"WebPage","@id":"/redis/2024/03/05/redis-keys-flushall.html"},"url":"/redis/2024/03/05/redis-keys-flushall.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="icon" href="">
  <link rel="canonical" href="">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-noto-sans@0.0.72/index.min.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <script src="/assets/js/main.js"></script><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Young's Logs">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<!-- and it's easy to individually load additional languages -->
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/go.min.js" async></script>



















<script>
// Init highlight js
document.addEventListener('DOMContentLoaded', function(event) {
  var els = document.querySelectorAll('pre code')

  function addLangData(block) {
    var outer = block.parentElement.parentElement.parentElement;
    var lang = block.getAttribute('data-lang');
    for (var i = 0; i < outer.classList.length; i++) {
      var cls = outer.classList[i];
      if (cls.startsWith('language-')) {
        lang = cls;
        break;
      }
    }
    if (!lang) {
      cls = block.getAttribute('class');
      lang = cls ? cls.replace('hljs ', '') : '';
    }
    if (lang.startsWith('language-')) {
      lang = lang.substr(9);
    }
    block.setAttribute('class', 'hljs ' + lang);
    block.parentNode.setAttribute('data-lang', lang);
  }

  function addBadge(block) {
    var enabled = ('true' || 'true').toLowerCase();
    if (enabled == 'true') {
      var pre = block.parentElement;
      pre.classList.add('badge');
    }
  }

  function handle(block) {
    addLangData(block);
    addBadge(block)
    hljs.highlightBlock(block);
  }

  for (var i = 0; i < els.length; i++) {
    var el = els[i];
    handle(el);
  }
});
</script>

<style>
  /* code language badge */
  pre.badge::before {
    content: attr(data-lang);
    color: #fff;
    background-color: #ff4e00;
    padding: 0 .5em;
    border-radius: 0 2px;
    text-transform: uppercase;
    text-align: center;
    min-width: 32px;
    display: inline-block;
    position: absolute;
    right: 0;
  }

  /* fix wrong badge display for firefox browser */
  code > table pre::before {
    display: none;
  }
</style>
<script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/umd/photoswipe-lightbox.umd.min.js" async></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/umd/photoswipe.umd.min.js" async></script>
<link href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/photoswipe.min.css" rel="stylesheet">
<style>
  .pswp .pswp__container .pswp__img {
    background-color: white;
  }
</style>

<script>
  function initPhotoSwipe() {
    let customOptions = {};

    try {
      const data = ``.replaceAll("=>", ":");
      customOptions = JSON.parse(data);
    } catch (e) {
      console.info("Invalid custom photo previewer options! " + e.message);
    }

    // Define object and gallery options
    const options = Object.assign(
      {
        gallery: "section.main",
        children: "a.photo-swipe",
        photo_scale: 2,
        // dynamic import is not supported in UMD version
        pswpModule: PhotoSwipe,
      },
      customOptions
    );

    const galleryEl = document.querySelector(options.gallery);
    if (!galleryEl) {
      return;
    }

    const imgEls = [];
    const els = galleryEl.querySelectorAll("img:not(.emoji)");
    els.forEach((el) => {
      if (el.src.trim() == "") {
        return;
      }
      if (!imgEls.includes(el)) {
        imgEls.push(el);
      }
    });

    if (imgEls.length === 0) {
      return;
    }

    imgEls.forEach((imgEl) => {
      imgEl.outerHTML = `
      <a class="photo-swipe"
        href="${imgEl.src}"
        data-pswp-width="${
          Math.max(imgEl.naturalWidth, imgEl.width) * options.photo_scale
        }"
        data-pswp-height="${
          Math.max(imgEl.naturalHeight, imgEl.height) * options.photo_scale
        }"
        data-pswp-caption="${imgEl.getAttribute("caption") || imgEl.alt}"
        target="_blank">
        ${imgEl.outerHTML}
      </a>`;
    });

    // Initialize PhotoSwipe 5
    var lightbox = new PhotoSwipeLightbox(options);

    lightbox.init();
  }

  window.addEventListener("load", initPhotoSwipe);
</script>
</head>
<body>



























































































































<header class="site-header " role="banner">

  <div class="wrapper">
    <div class="site-header-inner">
<span class="site-brand"><a class="site-brand-inner" rel="author" href="/">
  <img class="site-favicon" title="Young's Logs" src="" onerror="this.style.display='none'">
  Young's Logs
</a>
</span><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger">
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewbox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
              </svg>
            </span>
          </label>

          <div class="trigger">
<a class="page-link" href="/about.html">ABOUT</a><a class="page-link" href="/archives.html">ARCHIVES</a><a class="page-link" href="/categories.html">CATEGORIES</a><a class="page-link" href="/">HOME</a><a class="page-link" href="/tags.html">TAGS</a>









<div class="page-link" style="display: inline;">



<div id="google_translate_element" style="display: none;">
</div>

<div class="ct-language">
  <ul class="list-unstyled ct-language-dropdown">
    
      <li>
        <a href="#" class="lang-select" data-lang="en">
          
          <img src="https://cdn.countryflags.com/thumbs/united-states-of-america/flag-400.png" title="English">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="fr">
          
          <img src="https://cdn.countryflags.com/thumbs/france/flag-400.png" title="French">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="zh-CN">
          
          <img src="https://cdn.countryflags.com/thumbs/china/flag-400.png" title="Chinese(Simple)">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ja">
          
          <img src="https://cdn.countryflags.com/thumbs/japan/flag-400.png" title="Japanese">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ko">
          
          <img src="https://cdn.countryflags.com/thumbs/south-korea/flag-400.png" title="Korean">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ru">
          
          <img src="https://cdn.countryflags.com/thumbs/russia/flag-400.png" title="Russian">
          
        </a>
      </li>
    
  </ul>
</div>

<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'en',
    autoDisplay: false,
    layout: google.translate.TranslateElement.InlineLayout.VERTICAL
  }, 'google_translate_element');

  // Links to cross-origin destinations are unsafe
  var gll = document.getElementsByClassName('goog-logo-link')[0];
  if (gll) {
    gll.setAttribute('rel', 'noopener');
  }

  function restoreLang() {
    var iframe = document.getElementsByClassName('goog-te-banner-frame')[0];
    if (!iframe) return;

    var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
    var restore_el = innerDoc.getElementsByTagName("button");

    for (var i = 0; i < restore_el.length; i++) {
      if (restore_el[i].id.indexOf("restore") >= 0) {
        restore_el[i].click();
        var close_el = innerDoc.getElementsByClassName("goog-close-link");
        close_el[0].click();
        return;
      }
    }
  }

  function triggerHtmlEvent(element, eventName) {
    var event;
    if (document.createEvent) {
      event = document.createEvent('HTMLEvents');
      event.initEvent(eventName, true, true);
      element.dispatchEvent(event);
    } else {
      event = document.createEventObject();
      event.eventType = eventName;
      element.fireEvent('on' + event.eventType, event);
    }
  }

  var googleCombo = document.querySelector("select.goog-te-combo");
  var langSelect = document.querySelector('.ct-language');
  langSelect.addEventListener('click', function(event) {
    if (!event.target) {
      return;
    }

    var selected = document.querySelector('.ct-language .ct-language-selected');
    if (selected) {
      selected.classList.remove('ct-language-selected');
    }

    var target = event.target;
    while (target && target !== langSelect ) {
      if (target.matches('.lang-select')) {
        break;
      }
      target = target.parentElement;
    }

    if (target && target.matches('.lang-select')) {
      var lang = target.getAttribute('data-lang');
      if (googleCombo.value == lang) {
        restoreLang();
      } else {
        target.parentElement.classList.add('ct-language-selected');
        googleCombo.value = lang;
        triggerHtmlEvent(googleCombo, 'change');
      }
    }

    event.preventDefault();
  });
}
</script>

<script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" async></script>
</div>
</div>
        </nav>
</div>
  </div>
</header>

<script>
  function initHeader() {
    var lastScrollY = getScrollPos().y;
    var documentElement = document.documentElement;

    function storeScrollData() {
      var y = getScrollPos().y;var scrollStatus = "";

      if (y <= 0) {
        scrollStatus = "top";
      } else if ((window.innerHeight + y) >= document.body.offsetHeight) {
        scrollStatus = "bottom";
      } else {
        var isScrollDown = (y - lastScrollY > 0) ? true : false;
        scrollStatus = isScrollDown ? "down" : "up";
      }

      lastScrollY = y;
      documentElement.setAttribute("data-scroll-status", scrollStatus);
    }

    window.addEventListener('scroll', function(e) {
      storeScrollData();
    });

    storeScrollData();
  }
  document.addEventListener('DOMContentLoaded', initHeader);
</script>
















































































































































<script>
  function hashLocate(hashValue) {
    hashValue = hashValue.replace(/^.*#h-/, '');
    hashValue = decodeURIComponent(hashValue);
    var element = document.getElementById(hashValue);

    if (!element) {
      return;
    }

    var header = document.querySelector('header.site-header');
    var headerRect = header.getBoundingClientRect();
    var headerTop = Math.floor(headerRect.top);
    var headerHeight = Math.floor(headerRect.height);
    var scrollPos = getScrollPos();
    var offsetY = element.offsetTop - (headerTop + headerHeight + 20);

    if (offsetY == scrollPos.y) {
      return;
    }

    if (headerTop == 0  && offsetY > scrollPos.y) {
      offsetY += headerHeight + 2;
    } else if (headerTop < 0  && offsetY < scrollPos.y) {
      offsetY -= headerHeight - 2;
    }

    smoothScrollTo(offsetY);
  }

  // The first event occurred
  window.addEventListener('load', function(event) {
    if (window.location.hash) {
      hashLocate(window.location.hash);
    }
  });

  // The first event occurred
  window.addEventListener('click', function(event) {
    if (event.target.tagName.toLowerCase() == 'a') {
      hashLocate(event.target.getAttribute('href'));
    }
  });
</script>
<div class="theme-toggle">
  <input type="checkbox" id="theme-switch">
  <label for="theme-switch">
    <div class="toggle"></div>
    <div class="names">
      <p class="light">Light</p>
      <p class="dark">Dark</p>
    </div>
  </label>
</div>




<script>
  (function() {
    var sw = document.getElementById('theme-switch');
    var html = document.getElementsByTagName('html')[0];
    var nightModeOption = ('auto' || 'auto').toLowerCase();
    var storage = nightModeOption === 'manual'
        ? localStorage
        : sessionStorage;
    var themeData = loadThemeData();

    function saveThemeData(data) {
      storage.setItem('theme', JSON.stringify(data));
    }

    function loadThemeData() {
      var data = storage.getItem('theme');
      try {
        data = JSON.parse(data ? data : '');
      } catch(e) {
        data = { nightShift: undefined, autoToggleAt: 0 };
        saveThemeData(data);
      }
      return data;
    }

    function handleThemeToggle(nightShift) {
      themeData.nightShift = nightShift;
      saveThemeData(themeData);
      html.dataset.theme = nightShift ? 'dark' : 'light';
      setTimeout(function() {
        sw.checked = nightShift ? true : false;
      }, 50);
    }

    function autoThemeToggle() {
      // Next time point of theme toggle
      var now = new Date();
      var toggleAt = new Date();
      var hours = now.getHours();
      var nightShift = hours >= 19 || hours <=7;

      if (nightShift) {
        if (hours > 7) {
          toggleAt.setDate(toggleAt.getDate() + 1);
        }
        toggleAt.setHours(7);
      } else {
        toggleAt.setHours(19);
      }

      toggleAt.setMinutes(0);
      toggleAt.setSeconds(0);
      toggleAt.setMilliseconds(0)

      var delay = toggleAt.getTime() - now.getTime();

      // auto toggle theme mode
      setTimeout(function() {
        handleThemeToggle(!nightShift);
      }, delay);

      return {
        nightShift: nightShift,
        toggleAt: toggleAt.getTime()
      };
    }

    // Listen the theme toggle event
    sw.addEventListener('change', function(event) {
      handleThemeToggle(event.target.checked);
    });

    if (nightModeOption == 'auto') {
      var data = autoThemeToggle();

      // Toggle theme by local setting
      if (data.toggleAt > themeData.autoToggleAt) {
        themeData.autoToggleAt = data.toggleAt;
        handleThemeToggle(data.nightShift);
      } else {
        handleThemeToggle(themeData.nightShift);
      }
    } else if (nightModeOption == 'manual') {
      handleThemeToggle(themeData.nightShift);
    } else {
      var nightShift = themeData.nightShift;
      if (nightShift === undefined) {
        nightShift = nightModeOption === 'on';
      }
      handleThemeToggle(nightShift);
    }
  })();
</script>
<div id="click-to-top" class="click-to-top">
  <i class="fa fa-arrow-up"></i>
</div>
<script>
  (function () {
    const clickToTop = document.getElementById('click-to-top');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 100) {
        clickToTop.classList.add('show')
      }else {
        clickToTop.classList.remove('show')
      }
    });
    clickToTop.addEventListener('click', () => {
      window.smoothScrollTo(0);
    });
  })();
</script>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="framework">
  <section class="main">

     <div class="post">
  <section>









<header class="post-header">
  <h1 class="post-title p-name" itemprop="name headline">KEYS와 FLUSHALL 명령어를 쓰지 말아야되는 이유</h1>
  <h2 class="post-subtitle"></h2>

  <div class="post-meta">
    <time class="dt-published" datetime="2024-03-05T00:00:00+00:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Mar 05, 2024
    </time>
    
































    <span class="post-reading-time left-vsplit"><i class="fa fa-clock-o"></i> About 17 mins</span>
  </div>
<div class="post-tags"><a class="post-tag" href="/tags.html#redis">#redis</a></div></header>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="post-content e-content" itemprop="articleBody">

      <p>Redis를 사용하다 보면 의도하지 않은 장애가 발생하거나 성능이 저하되는 경우가 있습니다.
이들은 모두 Redis가 싱글 스레드라는 것을 잊어 버리거나 모르고 있기 때문에 발생하는 문제입니다.</p>

<p>Redis는 싱글 스레드이기 때문에, 태생적으로 하나의 명령이 오랜 시간을 소모하는 작업에는 적합하지 않습니다.
그러나 이러한 특성을 이해하지 못하는 경우 장애가 발생하게 됩니다.</p>

<p>이번 글에서는 <code class="language-plaintext highlighter-rouge">KEYS</code>와 <code class="language-plaintext highlighter-rouge">FLUSHALL</code> 명령어가 왜 장애의 원인될 수 있는지 알아보겠습니다.</p>

<h2 id="서버에서-keys-명령를-쓰지-말자">서버에서 KEYS 명령를 쓰지 말자</h2>

<p><code class="language-plaintext highlighter-rouge">KEYS</code> 명령어는 특정 패턴에 매칭되는 키를 찾아주는 명령어입니다.
예를 들어, <code class="language-plaintext highlighter-rouge">KEYS *</code>는 모든 키를 찾아주고, <code class="language-plaintext highlighter-rouge">KEYS user:*</code>는 <code class="language-plaintext highlighter-rouge">user:</code>로 시작하는 모든 키를 찾아줍니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>redis 127.0.0.1:6379&gt; keys user:<span class="k">*</span>
  1<span class="o">)</span> <span class="s2">"user"</span>
  2<span class="o">)</span> <span class="s2">"user:1h"</span>
  3<span class="o">)</span> <span class="s2">"user:2h"</span>
</code></pre></div></div>

<p>지원하는 glob-style 패턴을 살펴보면 다음과 같습니다.</p>

<table>
  <thead>
    <tr>
      <th>패턴</th>
      <th>설명</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>h?llo</td>
      <td>matches hello, hallo and hxllo</td>
    </tr>
    <tr>
      <td>h*llo</td>
      <td>matches hllo and heeeello</td>
    </tr>
    <tr>
      <td>h[ae]llo</td>
      <td>matches hello and hallo, but not hillo</td>
    </tr>
    <tr>
      <td>h[^e]llo</td>
      <td>matches hallo, hbllo, … but not hello</td>
    </tr>
    <tr>
      <td>h[a-b]llo</td>
      <td>matches hallo and hbllo</td>
    </tr>
  </tbody>
</table>

<p>여기까지 살펴보면 <code class="language-plaintext highlighter-rouge">KEYS</code> 명령어는 특정 패턴에 매칭되는 키를 찾아주는 강력한 명령어라는 것을 알 수 있습니다.
하지만 실제 서비스에서 해당 명령을 사용하면 장애로 이어질 가능성이 높습니다.</p>

<p><a href="https://redis.io/commands/keys/">Redis 매뉴얼</a>에서도 다음과 같이 해당 명령은 실제 제품에서는 쓰지말라고 권고하고 있습니다.</p>

<blockquote>
  <p>Warning: consider KEYS as a command that should only be used in production environments with extreme care.
It may ruin performance when it is executed against large databases.
This command is intended for debugging and special operations, such as changing your keyspace layout.
Don’t use KEYS in your regular application code.
If you’re looking for a way to find keys in a subset of your keyspace, consider using SCAN or sets.</p>
</blockquote>

<p>왜 그렇다면 <code class="language-plaintext highlighter-rouge">KEYS</code> 명령어를 사용하면 안된다고 권고 할까요?
소스코드를 보면 이해할 수 있습니다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">keysCommand</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>
    <span class="n">sds</span> <span class="n">pattern</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">plen</span> <span class="o">=</span> <span class="n">sdslen</span><span class="p">(</span><span class="n">pattern</span><span class="p">),</span> <span class="n">allkeys</span><span class="p">,</span> <span class="n">pslot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">numkeys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">replylen</span> <span class="o">=</span> <span class="n">addReplyDeferredLen</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="n">allkeys</span> <span class="o">=</span> <span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'*'</span> <span class="o">&amp;&amp;</span> <span class="n">plen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">cluster_enabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">allkeys</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pslot</span> <span class="o">=</span> <span class="n">patternHashSlot</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">kvstoreDictIterator</span> <span class="o">*</span><span class="n">kvs_di</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">kvstoreIterator</span> <span class="o">*</span><span class="n">kvs_it</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pslot</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvstoreDictSize</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">,</span> <span class="n">pslot</span><span class="p">))</span> <span class="p">{</span>
            <span class="cm">/* Requested slot is empty */</span>
            <span class="n">setDeferredArrayLen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">replylen</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">kvs_di</span> <span class="o">=</span> <span class="n">kvstoreGetDictSafeIterator</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">,</span> <span class="n">pslot</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">kvs_it</span> <span class="o">=</span> <span class="n">kvstoreIteratorInit</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">robj</span> <span class="n">keyobj</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">kvs_di</span> <span class="o">?</span> <span class="n">kvstoreDictIteratorNext</span><span class="p">(</span><span class="n">kvs_di</span><span class="p">)</span> <span class="o">:</span> <span class="n">kvstoreIteratorNext</span><span class="p">(</span><span class="n">kvs_it</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sds</span> <span class="n">key</span> <span class="o">=</span> <span class="n">dictGetKey</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">allkeys</span> <span class="o">||</span> <span class="n">stringmatchlen</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span><span class="n">plen</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">sdslen</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">initStaticStringObject</span><span class="p">(</span><span class="n">keyobj</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">keyIsExpired</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">keyobj</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">addReplyBulkCBuffer</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">sdslen</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
                <span class="n">numkeys</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_CLOSE_ASAP</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kvs_di</span><span class="p">)</span>
        <span class="n">kvstoreReleaseDictIterator</span><span class="p">(</span><span class="n">kvs_di</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kvs_it</span><span class="p">)</span>
        <span class="n">kvstoreIteratorRelease</span><span class="p">(</span><span class="n">kvs_it</span><span class="p">);</span>
    <span class="n">setDeferredArrayLen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">replylen</span><span class="p">,</span><span class="n">numkeys</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>소스 코드를 살펴보면, 현재 설정된 db의 모든 키를 모두 순회하며 stringmatchlen 함수를 통해 패턴에 매칭되는 키를 찾아주는 것을 알 수 있습니다.
이러한 방식으로 동작하기 때문에, 만약 Redis에 수십만개 이상의 키가 존재한다면, 해당 명령어를 실행하는 동안 다른 명령어들이 블로킹되어 성능이 저하될 수 있습니다.
그렇다면 어떻게 해야 할까요?</p>

<h3 id="scan-명령어를-사용하자">SCAN 명령어를 사용하자</h3>

<p><code class="language-plaintext highlighter-rouge">SCAN</code> 명령어는 <code class="language-plaintext highlighter-rouge">KEYS</code> 명령어와 비슷하게 동작하지만, 키를 순회하는 방식이 다릅니다.
SCAN 명령어는 요청을 여러 개의 작은 요청으로 분할하여 처리하므로, 대규모 데이터셋에서도 실시간으로 요청을 처리할 수 있습니다.</p>

<p>또한 Redis 클러스터에서는 KEYS 명령어를 사용할 수 없습니다.
대신 SCAN 명령어를 사용하여 클러스터 전체에서 키를 검색할 수 있습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; SCAN 0 MATCH user:<span class="k">*</span>
  1<span class="o">)</span> <span class="s2">"user"</span>
  2<span class="o">)</span> <span class="s2">"user:1h"</span>
  3<span class="o">)</span> <span class="s2">"user:2h"</span>
</code></pre></div></div>

<h2 id="서버에서-flushall-명령을-쓰지-말자">서버에서 FLUSHALL 명령을 쓰지 말자</h2>

<p>모든 데이터를 삭제하는 명령어인 ‘FLUSHALL/FLUSHDB’라는 명령어가 존재합니다.
Redis는 db라는 가상의 공간을 분리할 수 있는 개념을 제공하고, select 명령으로 이동할 수 있습니다.
이를 통해 같은 키라도 db ‘0번’이나 ‘1번’ 등으로 나누어 여러개의 데이터를 저장할 수 있습니다.
이런 db 하나의 내용을 통째로 지우는 것이 ‘FLUSHDB’ 명령입니다.
(따로 select 명령어로 db 지정하지 않을 시 0번을 사용합니다.)
또한, 모든 db의 내용을 지우는 것이 ‘FLUSHALL’ 명령입니다.</p>

<p>간단히 예를 들어 살펴 보겠습니다.
아래는 db 0번과 1번에 각각 ‘young’이라는 키를 생성하고 ‘123’, ‘456’이라는 값을 할당하였습니다.
이때 select 명령어로 db를 변경하여 각각의 db에 키를 가져올 수 있습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; <span class="k">select </span>0
OK
127.0.0.1:6379&gt; <span class="nb">set </span>name <span class="s1">'young'</span>
OK
127.0.0.1:6379&gt; get name
<span class="s2">"young"</span>
127.0.0.1:6379&gt; <span class="k">select </span>1
OK
127.0.0.1:6379[1]&gt; <span class="nb">set </span>firstname <span class="s1">'hwang'</span>
OK
127.0.0.1:6379[1]&gt; get firstname
<span class="s2">"hwang"</span>
</code></pre></div></div>

<p>flushdb를 사용하여 하나의 db를 선택하여 지우거나 flushall로 전체 db를 지울 때 주의를 해야합니다.
flushall 명령은 전체 데이터를 다 지우며, keys 명령처럼 많은 시간이 필요합니다.</p>

<p>fushall을 이용해서 데이터를 지우는 속도를 측정해보면 아이템 개수에 비례하여 시간이 걸립니다.</p>

<p>다음 소스 코드를 통해 flushall 명령에 대해 살펴 보겠습니다.</p>

<blockquote>
  <p>/src/db.c</p>
</blockquote>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* FLUSHALL [ASYNC]
 *
 * Flushes the whole server data set. */</span>
<span class="kt">void</span> <span class="nf">flushallCommand</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">getFlushCommandFlags</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="cm">/* flushall should not flush the functions */</span>
    <span class="n">flushAllDataAndResetRDB</span><span class="p">(</span><span class="n">flags</span> <span class="o">|</span> <span class="n">EMPTYDB_NOFUNCTIONS</span><span class="p">);</span> 

    <span class="cm">/* Without the forceCommandPropagation, when DBs were already empty,
     * FLUSHALL will not be replicated nor put into the AOF. */</span>
    <span class="n">forceCommandPropagation</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">PROPAGATE_REPL</span> <span class="o">|</span> <span class="n">PROPAGATE_AOF</span><span class="p">);</span>

    <span class="n">addReply</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">shared</span><span class="p">.</span><span class="n">ok</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>flushallCommand 함수는 FLUSHALL 명령을 처리하는 함수 입니다.
getFlushCommandFlags 함수를 통해 동기적으로 실행되어야 하는지, 아니면 비동기로 실행되어야 하는지 결정합니다.
flushAllDataAndResetRDB 함수를 통해 실제 데이터를 지우는 작업을 수행합니다.</p>

<blockquote>
  <p>/src/db.c</p>
</blockquote>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Flushes the whole server data set. */</span>
<span class="kt">void</span> <span class="nf">flushAllDataAndResetRDB</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">server</span><span class="p">.</span><span class="n">dirty</span> <span class="o">+=</span> <span class="n">emptyData</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">flags</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">child_type</span> <span class="o">==</span> <span class="n">CHILD_TYPE_RDB</span><span class="p">)</span> <span class="n">killRDBChild</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">saveparamslen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">rdbSaveInfo</span> <span class="n">rsi</span><span class="p">,</span> <span class="o">*</span><span class="n">rsiptr</span><span class="p">;</span>
        <span class="n">rsiptr</span> <span class="o">=</span> <span class="n">rdbPopulateSaveInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsi</span><span class="p">);</span>
        <span class="n">rdbSave</span><span class="p">(</span><span class="n">SLAVE_REQ_NONE</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">rdb_filename</span><span class="p">,</span><span class="n">rsiptr</span><span class="p">,</span><span class="n">RDBFLAGS_NONE</span><span class="p">);</span>
    <span class="p">}</span>

<span class="cp">#if defined(USE_JEMALLOC)
</span>    <span class="cm">/* jemalloc 5 doesn't release pages back to the OS when there's no traffic.
     * for large databases, flushdb blocks for long anyway, so a bit more won't
     * harm and this way the flush and purge will be synchronous. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EMPTYDB_ASYNC</span><span class="p">))</span>
        <span class="n">jemalloc_purge</span><span class="p">();</span>
<span class="cp">#endif
</span><span class="p">}</span>
</code></pre></div></div>

<p>emptyData 함수를 호출하여 모든 데이터를 비웁니다.
첫번째 인자로 -1을 넘겨주면 모든 db를 비우게 됩니다.</p>

<blockquote>
  <p>/src/db.c</p>
</blockquote>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Remove all data (keys and functions) from all the databases in a
 * Redis server. If callback is given the function is called from
 * time to time to signal that work is in progress.
 *
 * The dbnum can be -1 if all the DBs should be flushed, or the specified
 * DB number if we want to flush only a single Redis database number.
 *
 * Flags are be EMPTYDB_NO_FLAGS if no special flags are specified or
 * EMPTYDB_ASYNC if we want the memory to be freed in a different thread
 * and the function to return ASAP. EMPTYDB_NOFUNCTIONS can also be set
 * to specify that we do not want to delete the functions.
 *
 * On success the function returns the number of keys removed from the
 * database(s). Otherwise -1 is returned in the specific case the
 * DB number is out of range, and errno is set to EINVAL. */</span>
<span class="kt">long</span> <span class="kt">long</span> <span class="nf">emptyData</span><span class="p">(</span><span class="kt">int</span> <span class="n">dbnum</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span><span class="p">(</span><span class="n">callback</span><span class="p">)(</span><span class="n">dict</span><span class="o">*</span><span class="p">))</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">async</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EMPTYDB_ASYNC</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">with_functions</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EMPTYDB_NOFUNCTIONS</span><span class="p">);</span>
    <span class="n">RedisModuleFlushInfoV1</span> <span class="n">fi</span> <span class="o">=</span> <span class="p">{</span><span class="n">REDISMODULE_FLUSHINFO_VERSION</span><span class="p">,</span><span class="o">!</span><span class="n">async</span><span class="p">,</span><span class="n">dbnum</span><span class="p">};</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">removed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dbnum</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">dbnum</span> <span class="o">&gt;=</span> <span class="n">server</span><span class="p">.</span><span class="n">dbnum</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Fire the flushdb modules event. */</span>
    <span class="n">moduleFireServerEvent</span><span class="p">(</span><span class="n">REDISMODULE_EVENT_FLUSHDB</span><span class="p">,</span>
                          <span class="n">REDISMODULE_SUBEVENT_FLUSHDB_START</span><span class="p">,</span>
                          <span class="o">&amp;</span><span class="n">fi</span><span class="p">);</span>

    <span class="cm">/* Make sure the WATCHed keys are affected by the FLUSH* commands.
     * Note that we need to call the function while the keys are still
     * there. */</span>
    <span class="n">signalFlushedDb</span><span class="p">(</span><span class="n">dbnum</span><span class="p">,</span> <span class="n">async</span><span class="p">);</span>

    <span class="cm">/* Empty redis database structure. */</span>
    <span class="n">removed</span> <span class="o">=</span> <span class="n">emptyDbStructure</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">db</span><span class="p">,</span> <span class="n">dbnum</span><span class="p">,</span> <span class="n">async</span><span class="p">,</span> <span class="n">callback</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dbnum</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">flushSlaveKeysWithExpireList</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">with_functions</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">serverAssert</span><span class="p">(</span><span class="n">dbnum</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">functionsLibCtxClearCurrent</span><span class="p">(</span><span class="n">async</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Also fire the end event. Note that this event will fire almost
     * immediately after the start event if the flush is asynchronous. */</span>
    <span class="n">moduleFireServerEvent</span><span class="p">(</span><span class="n">REDISMODULE_EVENT_FLUSHDB</span><span class="p">,</span>
                          <span class="n">REDISMODULE_SUBEVENT_FLUSHDB_END</span><span class="p">,</span>
                          <span class="o">&amp;</span><span class="n">fi</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">removed</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>emptyDbStructure 함수를 호출하여 실제로 데이터베이스 구조를 비웁니다.</p>

<blockquote>
  <p>/src/db.c</p>
</blockquote>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Remove all keys from the database(s) structure. The dbarray argument
 * may not be the server main DBs (could be a temporary DB).
 *
 * The dbnum can be -1 if all the DBs should be emptied, or the specified
 * DB index if we want to empty only a single database.
 * The function returns the number of keys removed from the database(s). */</span>
<span class="kt">long</span> <span class="kt">long</span> <span class="nf">emptyDbStructure</span><span class="p">(</span><span class="n">redisDb</span> <span class="o">*</span><span class="n">dbarray</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dbnum</span><span class="p">,</span> <span class="kt">int</span> <span class="n">async</span><span class="p">,</span>
                           <span class="kt">void</span><span class="p">(</span><span class="n">callback</span><span class="p">)(</span><span class="n">dict</span><span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">removed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">startdb</span><span class="p">,</span> <span class="n">enddb</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dbnum</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">startdb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">enddb</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">dbnum</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">startdb</span> <span class="o">=</span> <span class="n">enddb</span> <span class="o">=</span> <span class="n">dbnum</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">startdb</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">enddb</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">removed</span> <span class="o">+=</span> <span class="n">kvstoreSize</span><span class="p">(</span><span class="n">dbarray</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">keys</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">emptyDbAsync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbarray</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">kvstoreEmpty</span><span class="p">(</span><span class="n">dbarray</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">keys</span><span class="p">,</span> <span class="n">callback</span><span class="p">);</span>
            <span class="n">kvstoreEmpty</span><span class="p">(</span><span class="n">dbarray</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">expires</span><span class="p">,</span> <span class="n">callback</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="cm">/* Because all keys of database are removed, reset average ttl. */</span>
        <span class="n">dbarray</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">avg_ttl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">dbarray</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">expires_cursor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">removed</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>kvstoreSize 함수를 호출하여 최종적으로 비워진 키의 수를 나타냅니다.
kvstoreEmpty 함수를 호출하여 데이터를 비웁니다.</p>

<blockquote>
  <p>/src/kvstore.c</p>
</blockquote>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">kvstoreEmpty</span><span class="p">(</span><span class="n">kvstore</span> <span class="o">*</span><span class="n">kvs</span><span class="p">,</span> <span class="kt">void</span><span class="p">(</span><span class="n">callback</span><span class="p">)(</span><span class="n">dict</span><span class="o">*</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">didx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">didx</span> <span class="o">&lt;</span> <span class="n">kvs</span><span class="o">-&gt;</span><span class="n">num_dicts</span><span class="p">;</span> <span class="n">didx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dict</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">kvstoreGetDict</span><span class="p">(</span><span class="n">kvs</span><span class="p">,</span> <span class="n">didx</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="n">kvstoreDictMetadata</span> <span class="o">*</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvstoreDictMetadata</span> <span class="o">*</span><span class="p">)</span><span class="n">dictMetadata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">metadata</span><span class="o">-&gt;</span><span class="n">rehashing_node</span><span class="p">)</span>
            <span class="n">metadata</span><span class="o">-&gt;</span><span class="n">rehashing_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">dictEmpty</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">callback</span><span class="p">);</span>
        <span class="n">freeDictIfNeeded</span><span class="p">(</span><span class="n">kvs</span><span class="p">,</span> <span class="n">didx</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">listEmpty</span><span class="p">(</span><span class="n">kvs</span><span class="o">-&gt;</span><span class="n">rehashing</span><span class="p">);</span>

    <span class="n">kvs</span><span class="o">-&gt;</span><span class="n">key_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">kvs</span><span class="o">-&gt;</span><span class="n">non_empty_dicts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">kvs</span><span class="o">-&gt;</span><span class="n">resize_cursor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">kvs</span><span class="o">-&gt;</span><span class="n">bucket_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kvs</span><span class="o">-&gt;</span><span class="n">dict_size_index</span><span class="p">)</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">kvs</span><span class="o">-&gt;</span><span class="n">dict_size_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">kvs</span><span class="o">-&gt;</span><span class="n">num_dicts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
    <span class="n">kvs</span><span class="o">-&gt;</span><span class="n">overhead_hashtable_lut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">kvs</span><span class="o">-&gt;</span><span class="n">overhead_hashtable_rehashing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>kvstoreGetDict 함수를 호출하여 kvstore의 dict를 가져옵니다.
dictEmpty 함수를 호출하여 딕셔너리를 비웁니다.</p>

<blockquote>
  <p>/src/dict.c</p>
</blockquote>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">dictEmpty</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">void</span><span class="p">(</span><span class="n">callback</span><span class="p">)(</span><span class="n">dict</span><span class="o">*</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">_dictClear</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">callback</span><span class="p">);</span>
    <span class="n">_dictClear</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">callback</span><span class="p">);</span>
    <span class="n">d</span><span class="o">-&gt;</span><span class="n">rehashidx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">d</span><span class="o">-&gt;</span><span class="n">pauserehash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">d</span><span class="o">-&gt;</span><span class="n">pauseAutoResize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>주어진 딕셔너리의 모든 항목을 비우는 역할을 합니다.
_dictClear 함수를 두 번 호출하여 딕셔너리의 두 해시 테이블을 비웁니다.
_dictClear 함수는 딕셔너리의 해시 테이블에서 모든 항목을 제거합니다.
_dictClear(d, 0, callback) 은 첫 번째 해시 테이블을, _dictClear(d, 1, callback) 는 두 번째 해시 테이블을 비웁니다.</p>

<blockquote>
  <p>/src/dict.c</p>
</blockquote>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Destroy an entire dictionary */</span>
<span class="kt">int</span> <span class="nf">_dictClear</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">htidx</span><span class="p">,</span> <span class="kt">void</span><span class="p">(</span><span class="n">callback</span><span class="p">)(</span><span class="n">dict</span><span class="o">*</span><span class="p">))</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

    <span class="cm">/* Free all the elements */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DICTHT_SIZE</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">ht_size_exp</span><span class="p">[</span><span class="n">htidx</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">ht_used</span><span class="p">[</span><span class="n">htidx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dictEntry</span> <span class="o">*</span><span class="n">he</span><span class="p">,</span> <span class="o">*</span><span class="n">nextHe</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">callback</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">65535</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">callback</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">he</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">ht_table</span><span class="p">[</span><span class="n">htidx</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="n">he</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">nextHe</span> <span class="o">=</span> <span class="n">dictGetNext</span><span class="p">(</span><span class="n">he</span><span class="p">);</span>
            <span class="n">dictFreeKey</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">he</span><span class="p">);</span>
            <span class="n">dictFreeVal</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">he</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entryIsKey</span><span class="p">(</span><span class="n">he</span><span class="p">))</span> <span class="n">zfree</span><span class="p">(</span><span class="n">decodeMaskedPtr</span><span class="p">(</span><span class="n">he</span><span class="p">));</span>
            <span class="n">d</span><span class="o">-&gt;</span><span class="n">ht_used</span><span class="p">[</span><span class="n">htidx</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
            <span class="n">he</span> <span class="o">=</span> <span class="n">nextHe</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/* Free the table and the allocated cache structure */</span>
    <span class="n">zfree</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">ht_table</span><span class="p">[</span><span class="n">htidx</span><span class="p">]);</span>
    <span class="cm">/* Re-initialize the table */</span>
    <span class="n">_dictReset</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">htidx</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">DICT_OK</span><span class="p">;</span> <span class="cm">/* never fails */</span>
<span class="p">}</span>
</code></pre></div></div>

<p>주어진 딕셔너리의 모든 항목을 제거하는 역할을 합니다.
먼저 해시 DICTHT_SIZE(d-&gt;ht_size_exp[htidx])로 테이블 크기와 d-&gt;ht_used[htidx] 로 해시 테이블에 사용된 항목 수를 확인 합니다.
dictEntry *he를 사용하여 현재 항목을 가져옵니다.
dictGetNext(he)를 사용하여 다음 항목을 가져옵니다.
dictFreeKey와 dictFreeVal 함수를 사용하여 키와 값을 제거합니다.
이처럼 실제 데이터를 일일이 삭제하는 것을 확인 할 수 있습니다.
따라서 지우는 속도가 O(n)이기 때문에 데이터 양에 영향을 받게 됩니다.</p>



    </div>

</article>
<div class="post-nav">
<a class="previous" href="/java/2024/03/01/java-java-17-features.html" title="Java 17 Features">Java 17 Features</a><span></span>
</div>
<div class="post-related">
      <div>Related Articles</div>
      <ul>
        <li class="">
          <a class="post-link" href="/redis/2024/02/16/redis-data-model.html" title="Redis Data Model">
            Redis Data Model<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li>
<li class="">
          <a class="post-link" href="/node/2022/04/30/node-cluster-mode.html" title="PM2 Cluster Mode의 이해">
            PM2 Cluster Mode의 이해<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li>
<li class="">
          <a class="post-link" href="/web/2023/12/03/web-page-performance.html" title="K-DEVCON 발표 - 웹 페이지 성능 측정 지표">
            K-DEVCON 발표 - 웹 페이지 성능 측정 지표<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li>
<li class="">
          <a class="post-link" href="/2022/05/11/java-reflection-basic.html" title="Java Reflection Basic">
            Java Reflection Basic<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li>
</ul>
    </div>
<div class="post-comments"></div></section>
</div>


  </section>
  <section class="sidebar" style="margin-left: 15px;">
    <!-- Get sidebar items --><style type="text/css" media="screen">
.post-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
</style>

<div class="post-menu">
  <div class="post-menu-title">TOC</div>
  <div class="post-menu-content"></div>
</div>

<script>
  function generateContent() {
    var menu = document.querySelector(".post-menu");
    var menuContent =  menu.querySelector(".post-menu-content");
    var headings = document.querySelector(".post-content").querySelectorAll("h2, h3, h4, h5, h6");

    // Hide menu when no headings
    if (headings.length === 0) {
      return menu.style.display = "none";
    }

    // Generate post menu
    var menuHTML = '';
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      menuHTML += (
        '<li class="h-' + h.tagName.toLowerCase() + '">'
        + '<a href="#h-' + h.getAttribute('id') + '">' + h.textContent + '</a></li>');
    }

    menuContent.innerHTML = '<ul>' + menuHTML + '</ul>';

    // The header element
    var header = document.querySelector('header.site-header');

    function doMenuCollapse(index, over_items) {
      var items = menuContent.firstChild.children;

      if (over_items == undefined) {
        over_items = 20;
      }

      if (items.length < over_items) {
        return;
      }

      var activeItem = items[index];
      var beginItem = activeItem
      var endItem = activeItem
      var beginIndex = index;
      var endIndex = index + 1;
      while (beginIndex >= 0
        && !items[beginIndex].classList.contains('h-h2')) {
        beginIndex -= 1;
      }
      while (endIndex < items.length
        && !items[endIndex].classList.contains('h-h2')) {
        endIndex += 1;
      }
      for (var i = 0; i < beginIndex; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
      for (var i = beginIndex + 1; i < endIndex; i++) {
        item = items[i]
        // if (!item.classList.contains('h-h2')) {
          item.style.display = '';
        // }
      }
      for (var i = endIndex; i < items.length; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
    }

    // Init menu collapsed
    doMenuCollapse(-1);

    // Active the menu item
    window.addEventListener('scroll', function (event) {
      var lastActive = menuContent.querySelector('.active');
      var changed = true;
      var activeIndex = -1;
      for (var i = headings.length - 1; i >= 0; i--) {
        var h = headings[i];
        var headingRect = h.getBoundingClientRect();
        var headerRect = header.getBoundingClientRect();
        var headerTop = Math.floor(headerRect.top);
        var headerHeight = Math.floor(headerRect.height);
        var headerHeight = headerTop + headerHeight + 20;
        if (headingRect.top <= headerHeight) {
          var id = 'h-' + h.getAttribute('id');
          var a = menuContent.querySelector('a[href="#' + id  + '"]');
          var curActive = a.parentNode;
          if (curActive) {
            curActive.classList.add('active');
            activeIndex = i;
          }
          if (lastActive == curActive) {
            changed = false;
          }
          break;
        }
      }
      if (changed) {
        if (lastActive) {
          lastActive.classList.remove('active');
        }
        doMenuCollapse(activeIndex);
      }
      event.preventDefault();
    });
  }
  generateContent();
</script>
</section>
</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">
    <div class="site-footer-inner">
<div>Unpublished Work <span class="copyleft">©</span> 2017-2024 Young Hwang</div>
      <div>Powered by <a title="Jekyll is a simple, blog-aware, static site
      generator." href="https://jekyllrb.com/">Jekyll</a> &amp; <a title="Yat, yet
      another theme." href="https://github.com/jeffreytse/jekyll-theme-yat">Yat Theme</a>.</div>
      <div class="footer-col rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a>
</div>
    </div>
  </div>
</footer>
</body>
</html>
